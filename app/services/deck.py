# app/services/deck.py
from __future__ import annotations

import json
import random
import hashlib
from pathlib import Path
from dataclasses import dataclass
from typing import List, Tuple


@dataclass(frozen=True)
class Card:
    name: str
    meaning_up: str
    meaning_rev: str


class TarotDeck:
    def __init__(self, path: str):
        self.cards: List[Card] = []
        p = Path(path)
        if p.exists() and p.stat().st_size > 10:
            data = json.loads(p.read_text(encoding="utf-8"))
            for it in data:
                self.cards.append(
                    Card(
                        name=it["name"],
                        meaning_up=it["meaning_up"],
                        meaning_rev=it["meaning_rev"],
                    )
                )
        else:
            # Фолбек: повна колода 78 карт (стислі значення)
            self.cards = _BUILTIN_78

    def draw(self, n: int, allow_reversed: bool = True) -> List[Tuple[Card, bool]]:
        picks = random.sample(self.cards, k=n)
        return [(c, bool(random.getrandbits(1)) if allow_reversed else False) for c in picks]

    def daily_card(self, user_id: int, day_key: str) -> Tuple[Card, bool]:
        """
        Детермінована «карта дня» для користувача на певну дату (локальну).
        day_key: 'YYYY-MM-DD'
        """
        seed = f"{user_id}-{day_key}".encode("utf-8")
        h = hashlib.sha256(seed).digest()
        idx = int.from_bytes(h[:4], "big") % len(self.cards)
        rev = bool(h[4] & 1)  # стабільна «перевернутість»
        return self.cards[idx], rev


# --- мінімальні значення (UA), 78 карт ---
_BUILTIN_78: List[Card] = [
    Card("Дурень (0)", "Початок, спонтанність, віра.", "Безрозсудність, ризик без плану."),
    Card("Маг (I)", "Воля, ініціатива, фокус.", "Маніпуляції, розпорошення."),
    Card("Верховна Жриця (II)", "Інтуїція, таємниці.", "Сумнів, від’єднаність."),
    Card("Імператриця (III)", "Ріст, турбота, творення.", "Застій, контроль."),
    Card("Імператор (IV)", "Структура, авторитет.", "Жорсткість, тиск."),
    Card("Ієрофант (V)", "Традиції, наставництво.", "Догматизм, бунт."),
    Card("Закохані (VI)", "Вибір серця, союз.", "Дисгармонія, хибний вибір."),
    Card("Колісниця (VII)", "Контроль, ривок, перемога.", "Втрачений контроль."),
    Card("Сила (VIII)", "Внутрішня міць, терпіння.", "Самосумнів, імпульсивність."),
    Card("Відлюдник (IX)", "Пошук істини, мудрість.", "Ізоляція, застій."),
    Card("Колесо Фортуни (X)", "Цикл, поворот, шанс.", "Опір змінам, спад."),
    Card("Справедливість (XI)", "Баланс, закон.", "Упередженість, наслідки."),
    Card("Повішений (XII)", "Інша перспектива, пауза.", "Застрягання, жертва намарно."),
    Card("Смерть (XIII)", "Завершення, трансформація.", "Опір завершенню."),
    Card("Поміркованість (XIV)", "Баланс, зцілення.", "Крайнощі, нетерплячість."),
    Card("Диявол (XV)", "Пристрасть, залежність.", "Звільнення, усвідомлення."),
    Card("Вежа (XVI)", "Руйнування ілюзій.", "Затягнута криза."),
    Card("Зірка (XVII)", "Надія, натхнення.", "Зневіра, виснаження."),
    Card("Місяць (XVIII)", "Підсвідоме, інтуїція.", "Прояснення, вихід з мороку."),
    Card("Сонце (XIX)", "Радість, ясність, успіх.", "Тимчасові перешкоди."),
    Card("Суд (XX)", "Пробудження, підсумок.", "Самокритика, відмова від уроків."),
    Card("Світ (XXI)", "Завершення, цілісність.", "Незавершеність."),
    # Кубки (14)
    Card("Туз Кубків", "Емоційний початок, натхнення.", "Блок емоцій, спустошення."),
    Card("2 Кубків", "Партнерство, взаємність.", "Нерівність, розлад."),
    Card("3 Кубків", "Свято, підтримка друзів.", "Надмір, плітки."),
    Card("4 Кубків", "Апатія, роздуми.", "Новий інтерес, пробудження."),
    Card("5 Кубків", "Жаль, втрата.", "Примирення, надія."),
    Card("6 Кубків", "Спогади, тепло.", "Застрягання в минулому."),
    Card("7 Кубків", "Ілюзії, вибір.", "Прояснення, фокус."),
    Card("8 Кубків", "Відхід, пошук сенсу.", "Страх змін, прив’язаність."),
    Card("9 Кубків", "Задоволення, бажання.", "Надмірність, порожня насолода."),
    Card("10 Кубків", "Гармонія сім’ї.", "Тріщини, конфлікт."),
    Card("Паж Кубків", "Натхнення, чутливість.", "Незрілість, уразливість."),
    Card("Лицар Кубків", "Романтика, креатив.", "Перебільшена мрійливість."),
    Card("Королева Кубків", "Емпатія, інтуїція.", "Переплутані межі."),
    Card("Король Кубків", "Емоційна зрілість.", "Маніпуляції почуттями."),
    # Пентаклі (14)
    Card("Туз Пентаклів", "Матеріальний шанс.", "Втрачені можливості."),
    Card("2 Пентаклів", "Баланс справ.", "Перевантаження."),
    Card("3 Пентаклів", "Командна робота.", "Несинхрон, его."),
    Card("4 Пентаклів", "Утримання, безпека.", "Скупість, страх втрати."),
    Card("5 Пентаклів", "Скарбність, криза.", "Підтримка знайдеться."),
    Card("6 Пентаклів", "Щедрість, обмін.", "Дисбаланс давати/брати."),
    Card("7 Пентаклів", "Терпіння, огляд прогресу.", "Нетерпіння, поспіх."),
    Card("8 Пентаклів", "Практика, майстерність.", "Рутина без росту."),
    Card("9 Пентаклів", "Самодостатність, достаток.", "Залежність, витрати."),
    Card("10 Пентаклів", "Рід, спадок, стабільність.", "Напруга в родині/бізнесі."),
    Card("Паж Пентаклів", "Вчення, можливість.", "Лінь, розсіяність."),
    Card("Лицар Пентаклів", "Старанність, стабільність.", "Застиглість, впертість."),
    Card("Королева Пентаклів", "Практичність, турбота.", "Надконтроль, матеріалізм."),
    Card("Король Пентаклів", "Надійність, бізнес.", "Скупість, твердість."),
    # Мечі (14)
    Card("Туз Мечів", "Ясність, істина.", "Туман, конфуз."),
    Card("2 Мечів", "Рішення, пауза.", "Зняття блоків, вибір."),
    Card("3 Мечів", "Біль серця.", "Зцілення, відпускання."),
    Card("4 Мечів", "Відпочинок, відновлення.", "Невчасна пасивність."),
    Card("5 Мечів", "Конфлікт, ціною будь-чого.", "Примирення, уроки."),
    Card("6 Мечів", "Перехід, подорож.", "Затримка переходу."),
    Card("7 Мечів", "Стратегія, хитрість.", "Викриття, відповідальність."),
    Card("8 Мечів", "Самообмеження.", "Вихід знайдено."),
    Card("9 Мечів", "Тривога, безсоння.", "Полегшення, підтримка."),
    Card("10 Мечів", "Кінець, дно.", "Відродження."),
    Card("Паж Мечів", "Ідеї, допитливість.", "Нетактовність, різкість."),
    Card("Лицар Мечів", "Ривок, рішучість.", "Поспіх, конфліктність."),
    Card("Королева Мечів", "Логіка, межі.", "Холодність, критика."),
    Card("Король Мечів", "Розум, порядок.", "Догматизм, жорсткість."),
    # Жезли (14)
    Card("Туз Жезлів", "Іскра, старт дії.", "Блок креативу."),
    Card("2 Жезлів", "План, перспектива.", "Страх кроку."),
    Card("3 Жезлів", "Розширення, очікування.", "Затримки, брак бачення."),
    Card("4 Жезлів", "Свято, стабільність.", "Дискомфорт вдома."),
    Card("5 Жезлів", "Змагання, тертя.", "Урегулювання."),
    Card("6 Жезлів", "Перемога, визнання.", "Заздрість, затримка."),
    Card("7 Жезлів", "Захист позиції.", "Виснаження."),
    Card("8 Жезлів", "Швидкість, новини.", "Затримка, хаос."),
    Card("9 Жезлів", "Стійкість, кордони.", "Перевтома."),
    Card("10 Жезлів", "Перенавантаження.", "Делегування, полегшення."),
    Card("Паж Жезлів", "Запал, дослідження.", "Непослідовність."),
    Card("Лицар Жезлів", "Драйв, пригоди.", "Імпульсивність."),
    Card("Королева Жезлів", "Харизма, впевненість.", "Сумніви, ревнощі."),
    Card("Король Жезлів", "Лідерство, бачення.", "Диктат, нетерпимість."),
]
